# 1.8.x Optimization & Security Audit Plan

Constraints
- No changes to core functionality or feature behavior
- No sensor name schema changes across entities/attributes
- Preserve public APIs, services, and attribute keys

How We Test
- Use Home Assistant dev instance for sensor/entity behavior (manual)
- Run test script: `test_api_direct.py` for API sanity
- Verify attribute payload sizes and chart examples render
- Confirm recorder statistics import validation across HA 2025.1–2026.x

## 1) Architecture & Async Boundaries
- Goal: Clear separation of concerns (API sync → cache → sensors → dashboards)
- Tasks:
  - Review `coordinator.py`, `usage_coordinator.py` for sync responsibilities and signal dispatch
  - Confirm sensors (`sensor.py`, `usage_sensor.py`) only read cache and never perform writes
  - Ensure `usage_cache.py` provides atomic and idempotent writes, single writer policy
- Acceptance:
  - Single source of truth for sync and statistics import in coordinator
  - No sensor-side writes; sensor updates are passive
  - Start/end of sync well-defined; no overlapping schedules
- Tests:
  - Trigger manual refresh service and observe orderly cache reloads
  - Validate dispatcher signals cause sensor attribute refresh exactly once

## 2) API Client Robustness & Security
- Goal: Durable HTTP interactions with safe logging
- Tasks:
  - Add explicit timeouts, retry w/backoff, and rate limiting in `contact_api.py`
  - Token management: refresh-on-expiry, never log secrets, redact error bodies
  - Standardize error handling (HTTP 4xx/5xx), distinguish transient vs terminal
- Acceptance:
  - No secrets/tokens in logs; errors are informative but sanitized
  - Transient failures recover via retry; terminal errors bubble with clear context
- Tests:
  - Simulate expired token; confirm re-authentication path
  - Force 502/404 via mock; ensure retry/skip logic behaves

## 3) Concurrency & IO Safety
- Goal: Prevent race conditions and ensure consistent file operations
- Tasks:
  - Audit asyncio locks around cache save/load; confirm single writer across components
  - Verify atomic temp-file rename pattern; remove duplicate writes
  - Idempotent behavior under concurrent sensor reads
- Acceptance:
  - No FileNotFoundError or partial writes under stress
  - Cache remains consistent when multiple entities refresh simultaneously
- Tests:
  - Parallel refresh triggers; validate stable sensor attributes and cache integrity

## 4) Performance & Memory
- Goal: Reduce CPU/memory overhead without schema changes
- Tasks:
  - Profile dict merges, JSON serialization, and attribute build paths
  - Optimize daily→monthly rollups; avoid repeated compute on every update
  - Prune in-memory duplicates; ensure payload stays under HA limits
- Acceptance:
  - Attribute build time reduced; repo stays under 16KB attribute limits
  - No functional changes; charts read same keys
- Tests:
  - Measure timings pre/post optimization; confirm values unchanged

## 5) Home Assistant Compliance
- Goal: Strict adherence to HA integration standards
- Tasks:
  - Validate `manifest.json`, `strings.json`, translations, `config_flow.py`
  - Device info, entity categories, and state classes remain correct
  - Confirm compatibility across HA versions listed
- Acceptance:
  - HA loads without warnings; entities categorized properly
  - Config flow validations robust; clear error messages
- Tests:
  - Install in HA dev; run config flow; enable/disable entities; observe logs

## 6) Statistics Import Stability
- Goal: Recorder API compatibility and validation safety
- Tasks:
  - Reconfirm metadata dict creation w/out `mean_type` when `has_mean=False`
  - Timestamp normalization (top-of-hour/day, UTC) and cumulative rules
  - Sanitize `statistic_id` consistently (ICP format)
- Acceptance:
  - No deprecation/validation errors across HA releases
  - Energy Dashboard shows correct historical data
- Tests:
  - Import sample data; check recorder tables and dashboard

## 7) Sensor Entity Behavior
- Goal: Predictable updates, minimal surprises
- Tasks:
  - Validate enabled-by-default flags; ensure guidance when disabled
  - Confirm extra attributes (summary counts, displayed windows) are correct
- Acceptance:
  - Entities appear reliably; attributes align with cache window policies
- Tests:
  - Enable/disable, reload integration; confirm stable behavior

## 8) Dashboard Assets Consistency
- Goal: ApexCharts examples that work out-of-the-box
- Tasks:
  - Standardize data_generators for monthly partials using daily sums
  - Normalize timestamps to UTC month start; ensure `[timestamp, value]` format
- Acceptance:
  - Current month bar visible; no timezone artifacts
- Tests:
  - Render examples; validate January partial month shows

## 9) Documentation Alignment
- Goal: Clear and consistent docs
- Tasks:
  - Update README badges and wiki in line with 1.8.x scope
  - Add troubleshooting section for charts, statistics issues
- Acceptance:
  - Docs match behavior; setup steps clean and accurate
- Tests:
  - Fresh install walkthrough; dashboard import success

## 10) Testing Harness & Signoff
- Goal: Repeatable validation before release
- Tasks:
  - Define manual checklist and optional scripts for API/mock data
  - Record pass/fail per module; require signoff checklist completion
- Acceptance:
  - Checklist completed for each module
- Tests:
  - Run `test_api_direct.py`; verify endpoints & serialization

---

Audit Log & Signoff
- Date:
- Auditor:
- Modules Verified: Architecture / API / Concurrency / Performance / Compliance / Statistics / Sensors / Dashboards / Docs
- Notes:
- Ready for Release: Yes/No

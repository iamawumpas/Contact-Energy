# Agent Instructions for Contact Energy Integration

## Environment & Configuration
- **Home Assistant Version:** Core 2025.12.5
- **Current Project:** Usage Data Download Feature (Phase 1: v1.4.x)
- **Protected Version:** v1.3.1 (stable branch: `stable-1.3.1`)
- **Next Milestone:** Phase 1 completion - API download & caching implementation

---

## üéØ Autonomous Actions (No Authorization Required)

### Code Development
- Writing/fixing code: bug fixes, code corrections, refactoring
- Improving logging and error messages
- Writing/updating tests
- Implementing new features (when user explicitly requests them)

‚ö†Ô∏è **Code must be staged/committed by user via release.sh** - Agent writes code but cannot commit

### Changelog Management

‚ö†Ô∏è **CRITICAL RULE: NEVER write changelog entries during normal code changes/edits/additions/deletions**

**What the agent CANNOT do (EVER, during normal development):**
- ‚ùå Create changelog entries for bug fixes (NO MATTER WHAT)
- ‚ùå Create changelog entries for code edits or improvements
- ‚ùå Create changelog entries for new features or additions
- ‚ùå Create changelog entries for deletions or removals
- ‚ùå Create changelog entries for refactoring (NO MATTER WHAT)
- ‚ùå Create changelog entries "just to document" what was done
- ‚ùå Modify Changelog.md unless release.sh explicitly instructs it
- ‚ùå Write changelog entries autonomously under any circumstances

**ONLY Exception: When release.sh Explicitly Instructs**
- ‚úÖ ONLY when user runs `./release.sh X.Y.Z` and script requests changelog entry
- ‚úÖ ONLY for the specific version number that release.sh provides
- ‚úÖ ONLY if a changelog entry doesn't already exist for that version
- ‚úÖ IF the changelog entry already exists for that version, skip writing and just create the sentinel file

**If Changelog Entry Already Exists:**
- Do NOT rewrite the existing changelog entry
- Do NOT modify the existing changelog entry
- Simply create the sentinel file: `touch .agent_changelog_complete`
- Let release.sh proceed with the existing entry

**Why this rule exists:**
- Code changes happen incrementally; changelog entries are for intentional releases only
- User controls what gets documented and released
- Prevents changelog pollution from intermediate development work
- Keeps release history clean and intentional
- Changelog entries must match user's intent, not agent's interpretation

### General Guidelines
- **Code Quality:** Optimize for fastest execution
- **Design:** Follow https://developers.home-assistant.io/ guidelines
- **API Usage:** Reference .API_instructions.md and.API_Intructions_v2.md for Contact Energy API
- **Uncertainty:** When unsure what user is asking, STOP and ask clarifying questions
- **Code Comments:** Each piece of code must include human-friendly explanation
- **Approval Process:** Always suggest changes and wait for user approval before implementing

---

## üöÄ Release Workflow (Authorization Required)

**‚ö†Ô∏è ALL CODE CHANGES MUST GO THROUGH THIS WORKFLOW**

The release.sh script is the ONLY way code changes are committed to the repository.

### Agent Workflow: Code Writing

1. **Write/Fix Code**
   - Agent writes code, fixes bugs, improves tests
   - Code is created/modified in workspace files
   - **Agent does NOT commit to git**

2. **Notify User**
   - Tell user: "Code updated in [file]. Ready for staging when you run release.sh"
   - Provide summary of changes made

### User Workflow: Code Staging & Release

1. **User reviews code** (if desired)
   - User examines the modified files in the workspace
   - User asks agent for changes if needed

2. **User runs release.sh**
   ```bash
   ./release.sh x.y.z
   ```
   - This stages and commits all code changes
   - This creates changelog entry, tags, and GitHub release
   - Agent assists user during this process if needed

### Why This Approach?
- User has explicit control over every commit
- Clear separation: agent writes, user commits
- Prevents autonomous commits that bypass user oversight
- All commits tied to explicit release requests

---

## üöÄ Release Workflow (Authorization Required)

**‚ö†Ô∏è RELEASE ONLY WHEN USER EXPLICITLY REQUESTS IT**

**Authorization Trigger:** User must explicitly say "run release X.Y.Z"

### When User Requests a Release (with "run release X.Y.Z"):

1. **Reread Instructions First** (MANDATORY)
   - Reread this file (.Agent_Instructions.md) - especially Changelog Management
   - Reread .API_instructions.md and .API_Instructions_v2.md
   - You must verify you understand the current requirements
   
2. **Check Changelog Entry**
   - Look at Changelog.md to see if entry for version X.Y.Z already exists
   - **If entry ALREADY EXISTS:** Skip to Step 3, do NOT rewrite or modify it
   - **If entry DOES NOT exist:** Write a new changelog entry at the top
   
3. **Write Changelog Entry (ONLY if needed)**
   - This is the ONLY time you may create/modify Changelog.md
   - Only write a NEW entry if one doesn't already exist for this version
   - Update Changelog.md with new entry at the top (if needed)
   - Use format: `## [ X.Y.Z ]`
   - Include sections: ### Added, ### Fixed, ### Changed (as appropriate)
   - Changelog must be human-friendly (not code diffs), reflecting discussion context
   - Both the changelog and GitHub release summary must be identical
   
4. **Create Sentinel File**
   - Run: `touch .agent_changelog_complete`
   - This signals release.sh that changelog work is done (either new entry written or existing entry confirmed)
   
5. **Wait for Script Completion**
   - Do NOT run release.sh yourself
   - The user will run it
   - Script will handle all remaining steps

### Release Script Automation (release.sh)

**Purpose:** Automate version updates and GitHub release creation

**Usage:**
```bash
./release.sh x.y.z
```

**What release.sh Does:**
1. Validates changelog entry exists for version
2. Updates version in all files:
   - README.md (badge: ![Version](https://img.shields.io/badge/version-x.y.z-blue.svg))
   - manifest.json (version field)
   - HACS.json (version field)
3. Creates git commit with message "Release vx.y.z"
4. Creates git tag "vx.y.z"
5. Pushes commit and tag to repository
6. Creates GitHub release with automated changelog extraction

**Changelog Format (for extraction):**
```markdown
## [ x.y.z ]

### Added
- Item 1
- Item 2

### Fixed
- Item 1

## [ x.y.w ]
```

**Important Notes:**
- Changelog entry extraction is fully automated
- No additional files created by script
- Script assumes files are ready to be committed
- `release.sh` is a tool, NOT part of the integration
- Only the user can run release.sh (agent cannot initiate it autonomously)

---

## üìù Changelog Rules

### When Writing Changelog Entries:
- **ONLY when release.sh instructs** - Not autonomously
- Version Number: `[ x.y.z ]` format (ONLY as specified by release.sh)
- No Dates: Do not include timestamps
- Ordering: Newest entry always at the top
- Content: Human-friendly explanations, not code diffs
- Sections: Use ### Added, ### Fixed, ### Changed as appropriate
- Accuracy: Use discussion context between agent and user, not file diffs

### What NOT to Include in Changelog:
- Changes to release.sh (it's a tool, not part of integration)
- Changes to assets folder (yaml files, charts, etc.)
- Internal refactoring without user-facing impact
- **Predictive/outcome statements** - Do not claim results that haven't been tested:
  - ‚ùå "Statistics import now succeeds without errors"
  - ‚ùå "Usage data now imports correctly"
  - ‚ùå "Energy Dashboard now displays data"
  - ‚úÖ "Removed `mean_type=""` from StatisticMetaData to comply with Home Assistant requirements"
  - ‚úÖ "Changed calculation logic to prevent negative values"
  - Focus on WHAT was changed in the code, not predicting WHAT WILL happen

### When to Update Changelog:
- **ONLY when release.sh instructs during a release** - Agent does NOT create changelog entries autonomously
- **NEVER write changelog during normal development** - Code edits, additions, deletions, fixes must NOT trigger changelog updates
- **If changelog entry already exists** - Just create the sentinel file, do not rewrite or modify
- User can request amendments/corrections to existing entries anytime

---

## üí¨ Communication Standards

### User-Facing Instructions
- All instructions for data entry (accounts, passwords, etc.) must be **human-friendly and detailed**
- Update strings.json and translations/en.json for user-facing messages
- Keep language clear and accessible

### Code Comments
- Include human-friendly explanation in every code piece
- Explain the "why" not just the "what"
- Make comments useful for future maintenance

---

## üìö Critical Instruction Files

**‚ö†Ô∏è READ THESE FILES REGULARLY - THEY CONTAIN ESSENTIAL PROJECT CONTEXT**

### Primary Reference Documents
1. **[.usage_download_tasks.md](.usage_download_tasks.md)** - Detailed implementation tasks for usage data feature
   - Phase-by-phase breakdown (v1.4.x ‚Üí v2.0.0)
   - API specifications and cache structure
   - Testing criteria and success metrics

2. **[.Agent_Instructions.md](.Agent_Instructions.md)** - This file
   - Development guidelines and standards
   - Release process and automation
   - Communication and code quality requirements

3. **[.API_instructions.md](.API_instructions.md)** - Contact Energy API documentation
   - Endpoint specifications
   - Authentication flow and headers
   - Request/response formats and examples

### üîî Reminder System - When to Reread:

- **Every 10 messages:** Check `.usage_download_tasks.md` for current phase status
- **Every 15 messages:** Review `.Agent_Instructions.md` for process compliance
- **Before implementing new features:** Review relevant documentation
- **When user mentions "tasks" or "instructions":** Immediately reread all three files
- **When starting a new session:** Read all three instruction files completely
- **When uncertain about process:** Stop and reread this file

### üìã Quick Reference

| File | Purpose | Read When |
|------|---------|-----------|
| `.usage_download_tasks.md` | Usage feature implementation plan | Every 10 msgs, before coding, when resuming |
| `.Agent_Instructions.md` | Development process & standards | Every 15 msgs, when uncertain |
| `.API_instructions.md` | API technical specifications | When coding API calls, debugging API issues |

---

## üì° Wiki Updates

**When requested to update wiki:**
- Update BOTH the local wiki files (in `/wiki` directory) AND the online repository wiki
- If unsure about what goes online vs. local, ask first
- Maintain consistency between local and online versions

---

## üìä Sensor Attribute Names

### Usage Sensor Attributes
- **Canonical hourly attributes:** `hourly_paid_usage`, `hourly_free_usage`, `hourly_usage` (alias of paid)
- **Legacy aliases (backward compatible):** `hourly_data`, `hourly_free_data`
- **Preference:** Use canonical names in new dashboards and documentation

---

## üîÑ Summary of Key Rules

| Action | Requires Authorization? | Process |
|--------|------------------------|---------|
| Bug fixes / refactoring | ‚ùå No (code) | Write code in workspace |
| Committing code changes | ‚úÖ Yes | Only via user running release.sh |
| Creating changelog entries | ‚úÖ Yes | Only when release.sh instructs |
| New features | ‚úÖ Yes | Suggest changes, wait for approval |
| Creating a release | ‚úÖ Yes | Wait for explicit "Release vX.Y.Z" request |
| Running release.sh | ‚úÖ Yes | Only user runs it (you assist if asked) |
| Updating wiki | ‚úÖ Yes | Ask before proceeding |
| Git commits | ‚úÖ Yes | User via release.sh only |
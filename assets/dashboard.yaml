type: markdown
content: >+

  {# Define all entity names that should be formatted as currency ($X.XX) #}
  {% set currency_names = [
    'Current Balance',
    'Prepay Debt Balance',
    'Maximum Refund',
    'Amount Due',
    'Amount Paid',
    'Discount Total'
  ] %}


  {# Define all entity names that should be formatted as a human-readable date #}
  {% set date_names = [
    'Payment Due Date',
    'Next Bill Date'
  ] %}


  {# Define groups and their entities - All 24 sensors from v1.2.0 #}
  {# Replace {account}_{icp} with your actual account identifier (e.g., 71_oroua_st_0000000966tr348) #}
  {% set groups = [
    ('Account Balance', [
      ('Current Balance', 'sensor.{account}_{icp}_current_balance'),
      ('Prepay Debt Balance', 'sensor.{account}_{icp}_prepay_debt_balance'),
      ('Refund Eligible', 'sensor.{account}_{icp}_refund_eligible'),
      ('Maximum Refund', 'sensor.{account}_{icp}_maximum_refund')
    ]),
    ('Billing Information', [
      ('Amount Due', 'sensor.{account}_{icp}_amount_due'),
      ('Amount Paid', 'sensor.{account}_{icp}_amount_paid'),
      ('Discount Total', 'sensor.{account}_{icp}_discount_total'),
      ('Payment Due Date', 'sensor.{account}_{icp}_payment_due_date'),
      ('Days Until Overdue', 'sensor.{account}_{icp}_days_until_overdue')
    ]),
    ('Next Bill', [
      ('Next Bill Date', 'sensor.{account}_{icp}_next_bill_date'),
      ('Days Until Next Bill', 'sensor.{account}_{icp}_days_until_next_bill')
    ]),
    ('Account Settings', [
      ('Correspondence Preference', 'sensor.{account}_{icp}_correspondence_preference'),
      ('Payment Method', 'sensor.{account}_{icp}_payment_method'),
      ('Billing Frequency', 'sensor.{account}_{icp}_billing_frequency')
    ]),
    ('Contract Details', [
      ('Account Nickname', 'sensor.{account}_{icp}_account_nickname'),
      ('ICP', 'sensor.{account}_{icp}_icp'),
      ('Address', 'sensor.{account}_{icp}_address'),
      ('Product Name', 'sensor.{account}_{icp}_product_name'),
      ('Contract Type', 'sensor.{account}_{icp}_contract_type'),
      ('Contract Status', 'sensor.{account}_{icp}_contract_status')
    ]),
    ('Payment Plans', [
      ('Direct Debit', 'sensor.{account}_{icp}_is_direct_debit'),
      ('Smooth Pay', 'sensor.{account}_{icp}_is_smooth_pay'),
      ('Prepay', 'sensor.{account}_{icp}_is_prepay')
    ])
  ] %}

  {% set content_html = namespace(rows="") %}


  {# Iterate over groups and their entities #}
  {% for group_name, entities in groups %}
    
    {# Add an empty row for separation, but skip it for the very first group #}
    {% if not loop.first %}
      {% set content_html.rows = content_html.rows + '<tr><td colspan="2" style="padding: 0px 8px;"><br></td></tr>' %}
    {% endif %}

    {# Insert a full-width header row for the group name (Simple bold header with gray background) #}
    {% set header_style = 'text-align: left; padding: 6px 8px; font-weight: bold; background-color: rgba(120, 120, 120, 0.1);' %}
    {% set content_html.rows = content_html.rows + '<tr><td colspan="2" style="' + header_style + '"><strong>' + group_name + '</strong></td></tr>' %}
    
    {# Iterate over the entities within the current group #}
    {% for name, entity_id in entities %}
      {% set value = states(entity_id) %}
      
      {% set formatted_value = value %}

      {# Special Formatting Logic #}
      {% if value not in ['unknown', 'unavailable', 'none'] and value is not none %}
        {# Handle Currency Formatting ($X.XX) #}
        {% if name in currency_names %}
          {% set formatted_value = ('$%.2f' | format(value | float(0))) %}
        
        {# Handle Date Formatting (D MMM YYYY) #}
        {% elif name in date_names %}
          {% set formatted_value = value %}
        
        {# Handle Boolean values for Refund Eligible #}
        {% elif name == 'Refund Eligible' %}
          {% set formatted_value = 'Yes' if value | lower == 'true' or value == True else 'No' %}
        
        {# Handle Days Until values #}
        {% elif 'Days Until' in name %}
          {% set num = value | int(0) %}
          {% if num < 0 %}
            {% set formatted_value = (num | abs | string) + ' days overdue' %}
          {% else %}
            {% set formatted_value = num | string + ' days' %}
          {% endif %}
        {% endif %}
      {% else %}
        {% set formatted_value = 'â€”' %}
      {% endif %}
      
      {# Using the <small> tag to force a reduced font size via standard HTML structure #}
      {% set content_html.rows = content_html.rows + '<tr><td style="text-align: left; padding: 4px 8px;"><small>&nbsp;&nbsp;&nbsp;' + name + '</small></td><td align="right" style="padding: 4px 8px;"><small>' + formatted_value + '</small></td></tr>' %}
    {% endfor %}
  {% endfor %}


  <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <colgroup>
      <col style="width: 60%;">
      <col style="width: 40%;">
    </colgroup>
    <tr>
      <th colspan="2" align="center"><h3>Your Address<br>{account}_{icp}</h3></th>
    </tr>
    <tbody>
      {{ content_html.rows }}
    </tbody>
  </table>

text_only: true
view_layout:
  position: sidebar
card_mod:
  style:
    .: |
      ha-card {
        height: 500px !important;
        overflow-y: auto !important;
      }

# Changes Summary - Version 0.3.1

## Issue Analysis
The integration had three main issues:
1. **Excessive success logging** - Normal operations logged as warnings/errors
2. **Race condition** - Sensors tried to read coordinator data before first update completed
3. **Noisy 502 error logging** - Every retry attempt logged a warning, cluttering logs

## Changes Made

### 1. Cleaned Up Success Logging
**Files Modified:** `coordinator.py`, `sensor.py`, `api.py`

- Removed all success/info logging from coordinator (`_async_update_data`)
- Removed debug logs from sensor property getters
- Removed unnecessary contract matching debug logs
- Removed account details API response debug log
- **Result:** Only actual failures are logged now

### 2. Fixed Race Condition
**Files Modified:** `sensor.py`

Added two key mechanisms:

#### a) `available` property on sensor base classes
```python
@property
def available(self) -> bool:
    """Return if entity is available."""
    return self.coordinator.last_update_success and self.coordinator.data is not None
```
- Sensors report as "unavailable" until coordinator completes first successful update
- Home Assistant will show entities as "Unavailable" instead of empty/None values
- Prevents errors from trying to access non-existent data

#### b) Wait for first refresh in convenience sensors
```python
async def async_added_to_hass(self) -> None:
    if not self.coordinator.last_update_success or self.coordinator.data is None:
        await self.coordinator.async_config_entry_first_refresh()
```
- Convenience sensors wait for coordinator to complete first update before computing values
- Ensures API is ready before making usage data requests

#### c) Guard checks in data accessors
```python
def _get_account_data(self) -> dict[str, Any]:
    if not self.coordinator.last_update_success or self.coordinator.data is None:
        return {}
    # ... rest of logic
```
- Returns empty dict if coordinator isn't ready yet
- Prevents KeyError and AttributeError exceptions

### 3. Improved 502 Error Handling
**Files Modified:** `api.py`

Changed retry logging behavior:
- **Before:** Logged warning on every retry attempt (noisy)
- **After:** Logs at DEBUG level during retries, only logs WARNING if all retries fail

```python
# During retries - DEBUG level
_LOGGER.debug("Server error %s on %s; retrying in %ss (attempt %s/%s)", ...)

# After all retries fail - WARNING level
if last_server_error:
    _LOGGER.warning("Contact Energy API returned server error %s after %s retries for %s", ...)
```

**Result:** Logs are cleaner - only see warnings when retries are exhausted

## Testing Checklist

- [ ] Integration loads without errors
- [ ] Sensors show as "Unavailable" on first load, then become "Available" after ~4 seconds
- [ ] No race condition errors in logs
- [ ] Account detail sensors populate correctly
- [ ] Convenience sensors compute values correctly
- [ ] 502 errors only show WARNING after all retries fail (not on each attempt)
- [ ] No success messages cluttering logs

## Expected Log Behavior

### On Startup (Normal)
- No messages (silent success)
- Sensors briefly show "Unavailable" then populate

### On Startup (With 502 Errors)
- DEBUG logs during retries (not visible in default log level)
- Only WARNING if all retries exhausted: `Contact Energy API returned server error 502 after 2 retries for ...`

### On Error (Auth/Connection)
- ERROR: `Failed to fetch account data: ...`
- ERROR: `Authentication failed: ...`

## Notes
- The lint errors about unresolved imports are expected in the development environment - they resolve correctly when running in Home Assistant
- The 502 errors are external API issues on Contact Energy's side and cannot be fixed in code
- Users will see cleaner logs with this version

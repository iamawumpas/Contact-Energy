# Contact Energy API Documentation

## Overview

**Base URL:** `https://api.contact-digital-prod.net`

**API Key:** `kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij`

**Authentication:** Token-based (obtained via `/login/v2` endpoint)

---

## Required Headers for Authenticated Requests

```json
{
  "x-api-key": "kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij",
  "session": "<token>",
  "authorization": "<token>",
  "Content-Type": "application/json"
}
```

**Note:** All three headers are required. The API uses the token in both `session` and `authorization` headers (not as `Bearer {token}`).

---

## Working Endpoints

### 1. Authentication - POST `/login/v2`

**Status:** ✅ Fully Working

**Request:**
```http
POST https://api.contact-digital-prod.net/login/v2
Content-Type: application/json
x-api-key: kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij

{
  "username": "your_email@example.com",
  "password": "your_password"
}
```

**Response:**
```json
{
  "statusCode": 200,
  "token": "eCDfRqve0yCFEaWmtvMQoHlHgTXTRhHwgAAG-twz6ho=",
  "segment": "RESI",
  "bp": "1500479861"
}
```

**Available Fields:**
- `token` - Session token for authenticated requests
- `segment` - Customer segment (e.g., "RESI" for residential)
- `bp` - Business partner ID

---

### 2. Account Information - GET `/accounts/v2?ba=`

**Status:** ✅ Fully Working

**Request:**
```http
GET https://api.contact-digital-prod.net/accounts/v2?ba=
x-api-key: kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij
session: <token>
authorization: <token>
```

**Response Structure:**
```json
{
  "accountsSummary": [
    {
      "id": "1111222233",
      "nickname": "[your street name]",
      "contracts": [
        {
          "contractId": "1234567890",
          "premiseId": "0987654321",
          "address": "[Full address]"
        }
      ]
    }
  ],
  "accountDetail": {
    "id": "1111222233",
    "nickname": "[your street name]",
    "correspondencePreference": "email",
    "paymentMethod": "Direct Debit",
    "isDirectDebit": true,
    "isSmoothPay": false,
    "isPrepay": false,
    "isControlpay": false,
    "isEligibleMonthOff": false,
    "directDebitAccount": "0001",
    "billingFrequency": "Monthly",
    "accountBalance": {
      "prepayDebtBalance": 0,
      "currentBalance": 0,
      "formattedCurrentBalance": "$0.00",
      "remainingDays": 0,
      "refundEligible": false,
      "refundMax": 0,
      "refundInProgress": 0
    },
    "invoice": {
      "amountPaid": 0,
      "amountDue": 356.06,
      "discountTotal": 0,
      "paymentDueDate": "04 Dec 2023",
      "daysTilOverdue": -3
    },
    "nextBill": {
      "date": "19 Dec 2023",
      "daysUntilBill": 12
    },
    "contracts": [
      {
        "id": "1111222233",
        "premiseId": "0987654321",
        "address": "[full street address]",
        "icp": "00000xxxxxyyzzz",
        "product": {
          "name": "Broadband Power Combo - Anytime"
        },
        "type": "Energy",
        "status": "Active"
      }
    ]
  }
}
```

**Available Data Points (19 total):**

**Account Summary:**
- Account ID
- Account nickname
- Contract ID(s)
- Premise ID(s)
- Service address(es)

**Account Details:**
- Correspondence preference
- Payment method (Direct Debit, Credit Card, etc.)
- Billing frequency (Monthly, etc.)
- Account type flags (Direct Debit, Smooth Pay, Prepay, Control Pay)
- Month-off eligibility

**Account Balance:**
- Current balance (numeric and formatted)
- Prepay debt balance
- Remaining days
- Refund eligibility
- Refund maximum amount
- Refund in progress amount

**Invoice Information:**
- Amount paid
- Amount due
- Discount total
- Payment due date
- Days until overdue (negative = already overdue)

**Next Bill:**
- Next bill date
- Days until next bill

**Contract Details:**
- Contract ID
- Premise ID
- Service address
- ICP number (Installation Control Point)
- Product/plan name
- Contract type
- Contract status

---

### 3. Usage Data - POST `/usage/v2/{contract_id}`

**Status:** ✅ Fully Working (supports hourly, daily, and monthly intervals)

**URL Pattern:**
```
POST /usage/v2/{contract_id}?ba={account_id}&interval={interval}&from={start_date}&to={end_date}
```

**Parameters:**
- `contract_id` (path) - Contract ID from account data
- `ba` (query) - Account ID
- `interval` (query) - One of: `hourly`, `daily`, `monthly`
- `from` (query) - Start date in `YYYY-MM-DD` format
- `to` (query) - End date in `YYYY-MM-DD` format

#### Monthly Usage Example

**Example Request:**
```http
POST https://api.contact-digital-prod.net/usage/v2/1350836906?ba=501230645&interval=monthly&from=2025-11-07&to=2025-12-07
x-api-key: kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij
session: <token>
authorization: <token>
```

**Response:**
```json
[
  {
    "currency": "NZD",
    "year": 2023,
    "month": 12,
    "day": 1,
    "hour": 0,
    "date": "2023-12-01T00:00:00.000+13:00",
    "value": "168.540",
    "dollarValue": "46.820",
    "offpeakValue": "0",
    "unchargedValue": "0",
    "offpeakDollarValue": "0",
    "unit": "kWh",
    "timeZone": "Pacific/Auckland",
    "percentage": 100
  }
]
```

#### Daily Usage Example

**Example Request:**
```http
POST https://api.contact-digital-prod.net/usage/v2/1350836906?ba=501230645&interval=daily&from=2023-11-07&to=2023-12-07
x-api-key: kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij
session: <token>
authorization: <token>
```

**Response Sample:**
```json
{
  "currency": "NZD",
  "year": 2023,
  "month": 11,
  "day": 7,
  "hour": 0,
  "date": "2023-11-07T00:00:00.000+13:00",
  "value": "36.344",
  "dollarValue": "9.600",
  "offpeakValue": "0.00",
  "unchargedValue": "0.00",
  "offpeakDollarValue": "0.00",
  "unit": "kWh",
  "timeZone": "Pacific/Auckland",
  "percentage": 67.4
}
```

#### Hourly Usage Example

**Example Request:**
```http
POST https://api.contact-digital-prod.net/usage/v2/1350836906?ba=501230645&interval=hourly&from=2023-12-06&to=2023-12-06
x-api-key: kbIthASA7e1M3NmpMdGrn2Yqe0yHcCjL4QNPSUij
session: <token>
authorization: <token>
```

**Response Sample:**
```json
{
  "currency": "NZD",
  "year": 2023,
  "month": 12,
  "day": 6,
  "hour": 0,
  "date": "2023-12-06T00:00:00.000+13:00",
  "value": "1.53",
  "dollarValue": "0.526",
  "offpeakValue": "0.00",
  "unchargedValue": "0.00",
  "offpeakDollarValue": "0.000",
  "unit": "kWh",
  "timeZone": "Pacific/Auckland",
  "percentage": 34.62,
  "type": "dollar"
}
```

**Returns:** 24 records (one per hour) for the specified date

#### Available Usage Data Fields

Per usage record (hourly/daily/monthly):
- **Energy consumption (kWh)** - `value`
- **Cost (NZD)** - `dollarValue`
- **Off-peak usage (kWh)** - `offpeakValue`
- **Free/uncharged usage (kWh)** - `unchargedValue`
- **Off-peak cost (NZD)** - `offpeakDollarValue`
- **Date/timestamp** - `date` (with timezone: Pacific/Auckland)
- **Year, month, day, hour** - Individual components
- **Percentage indicator** - `percentage`
- **Currency** - `currency` (always "NZD")
- **Unit** - `unit` (always "kWh")
- **Timezone** - `timeZone` (always "Pacific/Auckland")
- **Type** - `type` (sometimes included, e.g., "dollar")

---

## Data Granularity

| Interval | Granularity | Data Points | Frequency |
|----------|------------|------------|-----------|
| **Hourly** | Per hour | 24 records per day | Available for any date |
| **Daily** | Per day | 1 record per day | Available for date ranges |
| **Monthly** | Per month | 1 record per month | Available for date ranges |

---

## Historical Data Retention

Based on the API implementation:
- **Monthly data**: Available for many months back (at least 2+ years)
- **Daily data**: Available for approximately 30+ days back
- **Hourly data**: Available for recent dates (typically last 1-2 weeks)

Contact Energy provides usage data with a **24-72 hour delay**. This is normal and applies to:
- Their website
- Their mobile app
- This integration

---

## Current Implementation Status

### ✅ Currently Implemented Features

The Contact Energy Home Assistant integration currently retrieves:

1. **Account Balance** (4 sensors)
   - Current balance
   - Prepay debt balance
   - Refund eligibility status
   - Refund amount

2. **Billing Information** (5 sensors)
   - Amount due
   - Payment due date
   - Days until/past due
   - Discount total
   - Amount paid

3. **Next Bill** (2 sensors)
   - Next bill date
   - Days until next bill

4. **Account Settings** (3 sensors)
   - Correspondence preference
   - Payment method
   - Billing frequency

5. **Contract Details** (6 sensors)
   - Contract ID
   - Premise ID
   - Service address
   - ICP number
   - Product name
   - Contract status

6. **Payment Plans** (3 sensors)
   - Direct debit status
   - Smooth pay status
   - Prepay status

**Total: 24 sensors**

### ⏳ Not Yet Implemented

- Detailed usage data (daily/hourly/monthly kWh) - **API endpoints available but not yet implemented in integration**
- Cost breakdown
- Rate information (peak/off-peak)
- Free hours tracking
- Historical usage trends
- Real-time usage monitoring

---

## Integration Recommendations

For Home Assistant integration development:

1. **Use Direct API calls** instead of the library
2. **Update frequency:**
   - Account data: Every 6 hours (slow-changing)
   - Daily/monthly usage: Every 1-4 hours
   - Hourly usage: Every 30-60 minutes
3. **Token management:** Implement re-authentication on 401/403 errors
4. **Error handling:** Use exponential backoff for 500 errors
5. **Data storage:** Store historical data as sensor attributes for charting

---

## Key Points

- **API is fully functional** for usage data retrieval
- **Three data intervals available**: hourly, daily, monthly
- **Free/off-peak breakdown** is provided for each interval
- **Timezone-aware timestamps** (Pacific/Auckland)
- **Currency always NZD** with both raw values and formatted costs
- **Usage data delay**: 24-72 hours from Contact Energy
- **Token-based authentication** with automatic refresh capability
- **Official API** - appears as regular website/app usage to Contact Energy

---

*Documentation generated from API analysis and testing*
*Last Updated: December 31, 2025*
